@model AppleShop.Controllers.DashboardVM
@{
    Layout = "_AdminLayout";
    ViewData["Title"] = "Tổng quan";
}

<div class="container-fluid py-4">
    <div class="mb-4">
        <div class="d-flex flex-wrap align-items-center gap-3">
            <!-- Bộ lọc thời gian -->
            <div class="d-flex gap-2">
                <select class="form-select form-select-sm" id="timeFilter" style="width: auto;">
                    <option value="today">Hôm nay</option>
                    <option value="yesterday">Hôm qua</option>
                    <option value="week">7 ngày qua</option>
                    <option value="month">30 ngày qua</option>
                    <option value="quarter">3 tháng qua</option>
                    <option value="year">Năm nay</option>
                    <option value="all">Tất cả</option>
                </select>
                <button class="btn btn-sm btn-outline-primary" id="refreshBtn">
                    <i class="fa-solid fa-rotate-right"></i> Làm mới
                </button>
            </div>

            <h3 class="mb-0 ms-auto">
                @{
                    var name = User?.FindFirst("HoTen")?.Value ?? User?.Identity?.Name ?? "Quản trị viên";
                }
                Xin chào, @name
            </h3>
        </div>
    </div>

    <!-- Thống kê chính -->
    <div class="row g-3 mb-4">
        <div class="col-md-4">
            <div class="card kpi-card">
                <div class="card-body d-flex align-items-center">
                    <div class="kpi-icon kpi-primary"><i class="fa-solid fa-cart-shopping"></i></div>
                    <div>
                        <p class="text-muted mb-1 small">Tổng Đơn Hàng</p>
                        <h4 class="fw-bold mb-0">@Model.TotalOrders</h4>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card kpi-card">
                <div class="card-body d-flex align-items-center">
                    <div class="kpi-icon kpi-success"><i class="fa-solid fa-sack-dollar"></i></div>
                    <div>
                        <p class="text-muted mb-1 small">Tổng Doanh Thu</p>
                        <h4 class="fw-bold mb-0">@string.Format("{0:N0} ₫", Model.TotalRevenue)</h4>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card kpi-card">
                <div class="card-body d-flex align-items-center">
                    <div class="kpi-icon kpi-info"><i class="fa-solid fa-box-open"></i></div>
                    <div>
                        <p class="text-muted mb-1 small">Sản Phẩm Đang Bán</p>
                        <h4 class="fw-bold mb-0">@Model.TotalProducts</h4>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Trạng thái đơn -->
    <div class="row g-3 mb-4">
        <div class="col-md-4">
            <div class="card kpi-card">
                <div class="card-body d-flex align-items-center">
                    <div class="kpi-icon kpi-warning"><i class="fa-solid fa-hourglass-half"></i></div>
                    <div><p class="text-muted mb-1 small">Đơn Chờ Xử Lý</p><h5>@Model.PendingOrders</h5></div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card kpi-card">
                <div class="card-body d-flex align-items-center">
                    <div class="kpi-icon kpi-primary"><i class="fa-solid fa-truck-fast"></i></div>
                    <div><p class="text-muted mb-1 small">Đơn Đang Giao</p><h5>@Model.ShippingOrders</h5></div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card kpi-card">
                <div class="card-body d-flex align-items-center">
                    <div class="kpi-icon kpi-success"><i class="fa-solid fa-circle-check"></i></div>
                    <div><p class="text-muted mb-1 small">Đơn Hoàn Thành</p><h5>@Model.DoneOrders</h5></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Top sản phẩm bán nhiều -->
    <div class="card border-0 shadow-sm">
        <div class="card-header bg-white border-bottom d-flex align-items-center">
            <h5 class="mb-0">Top sản phẩm bán nhiều</h5>
            <span class="ms-2 text-muted small">(Kỳ: @Model.Period)</span>
        </div>

        <div class="table-responsive">
            <table class="table align-middle mb-0">
                <thead class="small text-muted">
                    <tr>
                        <th style="width:56px">#</th>
                        <th>Sản phẩm</th>
                        <th class="text-end" style="width:100px">Đã bán</th>
                        <th class="text-end" style="width:160px">Tổng doanh thu</th>
                        <th class="text-end" style="width:140px">Giá trung bình</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model.TopByQty.Any())
                    {
                        var i = 1;
                        foreach (var p in Model.TopByQty)
                        {
                            <tr>
                                <td class="text-muted">@i</td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <img src="@(p.HinhAnh ?? Url.Content("~/imgs/no-image.png"))"
                                             onerror="this.src='@Url.Content("~/imgs/no-image.png")';"
                                             class="rounded me-3" style="width:42px;height:42px;object-fit:cover" />
                                        <div class="fw-semibold">@p.Ten</div>
                                    </div>
                                </td>
                                <td class="text-end fw-bold">@string.Format("{0:N0}", p.SoLuongBan)</td>
                                <td class="text-end text-success fw-semibold">@string.Format("{0:N0} ₫", p.TongDoanhThu)</td>
                                <td class="text-end text-muted">@string.Format("{0:N0} ₫", p.GiaTrungBinh)</td>
                            </tr>
                            i++;
                        }
                    }
                    else
                    {
                        <tr><td colspan="5" class="text-center text-muted py-4">Chưa có dữ liệu trong kỳ.</td></tr>
                    }
                </tbody>

            </table>
        </div>
    </div>
</div>

<style>
    .kpi-card {
        border: 0;
        border-radius: 14px;
        box-shadow: 0 6px 18px rgba(0,0,0,0.07);
        transition: transform .2s ease,box-shadow .2s ease;
    }

        .kpi-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.1);
        }

    .kpi-icon {
        width: 56px;
        height: 56px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 22px;
        color: #fff;
        margin-right: 14px;
    }

    .kpi-primary {
        background: linear-gradient(135deg,#3b82f6,#2563eb);
    }

    .kpi-success {
        background: linear-gradient(135deg,#22c55e,#16a34a);
    }

    .kpi-info {
        background: linear-gradient(135deg,#06b6d4,#0891b2);
    }

    .kpi-warning {
        background: linear-gradient(135deg,#f59e0b,#d97706);
    }

    .kpi-danger {
        background: linear-gradient(135deg,#ef4444,#dc2626);
    }

    table tr:hover {
        background: #fafafa;
    }
</style>

@section Scripts {
    <script>
        document.getElementById('timeFilter').value = '@Model.Period';
        document.getElementById('timeFilter').addEventListener('change', function(){
            const url = new URL(window.location.href);
            url.searchParams.set('period', this.value);
            window.location.href = url.toString();
        });
        document.getElementById('refreshBtn').addEventListener('click', ()=> location.reload());
    </script>
}
