@model AppleShop.Models.DonHang
@{
    ViewData["Title"] = "Chi tiết đơn hàng";

    string StatusText(int s) => s switch
    {
        0 => "Nháp",
        1 => "Mới",
        2 => "Đang giao",
        3 => "Hoàn tất",
        4 => "Hủy",
        _ => "?"
    };
}

<div class="card shadow-sm">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Đơn #@Model.MaDon — @StatusText(Model.TrangThai)</h5>
        <a class="btn btn-light border" href="/admin/orders">← Quay lại</a>
    </div>

    <div class="card-body">
        @if (TempData["ok"] != null)
        {
            <div class="alert alert-success">@TempData["ok"]</div>
        }

        <div class="row g-3 mb-3">
            <div class="col-md-6">
                <div><strong>Khách hàng:</strong> @Model.HoTen</div>
                <div><strong>SĐT:</strong> @Model.DienThoai</div>
                <div><strong>Địa chỉ:</strong> @Model.DiaChi</div>
                <div><strong>PT thanh toán:</strong> @Model.PhuongThucThanhToan</div>
            </div>
            <div class="col-md-6">
                <div><strong>Ngày tạo:</strong> @Model.NgayTao.ToString("dd/MM/yyyy HH:mm")</div>
                <div><strong>Ghi chú:</strong> @Model.GhiChu</div>

                <form method="post" action="/admin/orders/update-status" class="d-flex gap-2 mt-2">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="id" value="@Model.DonHangId" />
                    <select name="status" class="form-select" style="max-width:220px">
                        @for (int i = 0; i <= 4; i++)
                        {
                            string text = i == 0 ? "Nháp" :
                            i == 1 ? "Mới" :
                            i == 2 ? "Đang giao" :
                            i == 3 ? "Hoàn tất" : "Hủy";
                            <option value="@i" selected="@(Model.TrangThai == i ? "selected" : null)">@text</option>
                        }
                    </select>
                    <button class="btn btn-warning">Cập nhật trạng thái</button>
                </form>
            </div>
        </div>

        <div class="table-responsive">
            <table class="table table-bordered align-middle">
                <thead class="table-light">
                    <tr>
                        <th>Sản phẩm</th>
                        <th>Đơn giá</th>
                        <th>SL</th>
                        <th>Thành tiền</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var ct in Model.ChiTietDonHangs ?? Enumerable.Empty<AppleShop.Models.ChiTietDonHang>())
                    {
                        // Nếu DB có sẵn ThanhTien thì dùng, ngược lại tính = DonGia * SoLuong
                        decimal thanhTien = ct.ThanhTien != 0m ? ct.ThanhTien : (ct.DonGia * ct.SoLuong);

                        <tr>
                            <td>@(ct.SanPham?.Ten ?? $"SP#{ct.SanPhamId}")</td>
                            <td>@ct.DonGia.ToString("n0")</td>
                            <td>@ct.SoLuong</td>
                            <td>@thanhTien.ToString("n0")</td>
                        </tr>
                    }
                </tbody>
                <tfoot>
                    <tr>
                        <th colspan="3" class="text-end">Tổng cộng</th>
                        <th>@Model.TongTien.ToString("n0")</th>
                    </tr>
                </tfoot>
            </table>
        </div>

        <a class="btn btn-outline-secondary" href="/admin/orders/edit/@Model.DonHangId">
            Sửa thông tin KH
        </a>
    </div>
</div>
